//
//  Generated by the J2ObjC translator.  DO NOT EDIT!
//  source: ./core/src/java/org/apache/lucene/store/LockStressTest.java
//

#include "IOSClass.h"
#include "IOSObjectArray.h"
#include "J2ObjC_source.h"
#include "java/io/IOException.h"
#include "java/io/InputStream.h"
#include "java/io/OutputStream.h"
#include "java/io/PrintStream.h"
#include "java/lang/Exception.h"
#include "java/lang/Integer.h"
#include "java/lang/System.h"
#include "java/lang/Thread.h"
#include "java/lang/Throwable.h"
#include "java/lang/reflect/Field.h"
#include "java/net/InetSocketAddress.h"
#include "java/net/Socket.h"
#include "java/util/Random.h"
#include "org/apache/lucene/store/FSDirectory.h"
#include "org/apache/lucene/store/FSLockFactory.h"
#include "org/apache/lucene/store/Lock.h"
#include "org/apache/lucene/store/LockFactory.h"
#include "org/apache/lucene/store/LockObtainFailedException.h"
#include "org/apache/lucene/store/LockStressTest.h"
#include "org/apache/lucene/store/NoLockFactory.h"
#include "org/apache/lucene/store/SimpleFSDirectory.h"
#include "org/apache/lucene/store/VerifyingLockFactory.h"
#include "org/lukhnos/portmobile/file/Path.h"
#include "org/lukhnos/portmobile/file/Paths.h"

@interface OrgApacheLuceneStoreLockStressTest ()

+ (OrgApacheLuceneStoreFSLockFactory *)getNewLockFactoryWithNSString:(NSString *)lockFactoryClassName;

@end

__attribute__((unused)) static OrgApacheLuceneStoreFSLockFactory *OrgApacheLuceneStoreLockStressTest_getNewLockFactoryWithNSString_(NSString *lockFactoryClassName);

NSString *OrgApacheLuceneStoreLockStressTest_LOCK_FILE_NAME_ = @"test.lock";

@implementation OrgApacheLuceneStoreLockStressTest

+ (void)mainWithNSStringArray:(IOSObjectArray *)args {
  OrgApacheLuceneStoreLockStressTest_mainWithNSStringArray_(args);
}

+ (OrgApacheLuceneStoreFSLockFactory *)getNewLockFactoryWithNSString:(NSString *)lockFactoryClassName {
  return OrgApacheLuceneStoreLockStressTest_getNewLockFactoryWithNSString_(lockFactoryClassName);
}

- (instancetype)init {
  OrgApacheLuceneStoreLockStressTest_init(self);
  return self;
}

+ (const J2ObjcClassInfo *)__metadata {
  static const J2ObjcMethodInfo methods[] = {
    { "mainWithNSStringArray:", "main", "V", 0x9, "Ljava.lang.Exception;", NULL },
    { "getNewLockFactoryWithNSString:", "getNewLockFactory", "Lorg.apache.lucene.store.FSLockFactory;", 0xa, "Ljava.io.IOException;", NULL },
    { "init", NULL, NULL, 0x1, NULL, NULL },
  };
  static const J2ObjcFieldInfo fields[] = {
    { "LOCK_FILE_NAME_", NULL, 0x18, "Ljava.lang.String;", &OrgApacheLuceneStoreLockStressTest_LOCK_FILE_NAME_, NULL, .constantValue.asLong = 0 },
  };
  static const J2ObjcClassInfo _OrgApacheLuceneStoreLockStressTest = { 2, "LockStressTest", "org.apache.lucene.store", NULL, 0x1, 3, methods, 1, fields, 0, NULL, 0, NULL, NULL, NULL };
  return &_OrgApacheLuceneStoreLockStressTest;
}

@end

void OrgApacheLuceneStoreLockStressTest_mainWithNSStringArray_(IOSObjectArray *args) {
  OrgApacheLuceneStoreLockStressTest_initialize();
  if (((IOSObjectArray *) nil_chk(args))->size_ != 7) {
    [((JavaIoPrintStream *) nil_chk(JreLoadStatic(JavaLangSystem, out_))) printlnWithNSString:@"Usage: java org.apache.lucene.store.LockStressTest myID verifierHost verifierPort lockFactoryClassName lockDirName sleepTimeMS count\n\n  myID = int from 0 .. 255 (should be unique for test process)\n  verifierHost = hostname that LockVerifyServer is listening on\n  verifierPort = port that LockVerifyServer is listening on\n  lockFactoryClassName = primary FSLockFactory class that we will use\n  lockDirName = path to the lock directory\n  sleepTimeMS = milliseconds to pause betweeen each lock obtain/release\n  count = number of locking tries\n\nYou should run multiple instances of this process, each with its own\nunique ID, and each pointing to the same lock directory, to verify\nthat locking is working correctly.\n\nMake sure you are first running LockVerifyServer."];
    JavaLangSystem_exitWithInt_(1);
  }
  jint arg = 0;
  jint myID = JavaLangInteger_parseIntWithNSString_(IOSObjectArray_Get(args, arg++));
  if (myID < 0 || myID > 255) {
    [((JavaIoPrintStream *) nil_chk(JreLoadStatic(JavaLangSystem, out_))) printlnWithNSString:@"myID must be a unique int 0..255"];
    JavaLangSystem_exitWithInt_(1);
  }
  NSString *verifierHost = IOSObjectArray_Get(args, arg++);
  jint verifierPort = JavaLangInteger_parseIntWithNSString_(IOSObjectArray_Get(args, arg++));
  NSString *lockFactoryClassName = IOSObjectArray_Get(args, arg++);
  OrgLukhnosPortmobileFilePath *lockDirPath = OrgLukhnosPortmobileFilePaths_getWithNSString_(IOSObjectArray_Get(args, arg++));
  jint sleepTimeMS = JavaLangInteger_parseIntWithNSString_(IOSObjectArray_Get(args, arg++));
  jint count = JavaLangInteger_parseIntWithNSString_(IOSObjectArray_Get(args, arg++));
  OrgApacheLuceneStoreLockFactory *lockFactory = OrgApacheLuceneStoreLockStressTest_getNewLockFactoryWithNSString_(lockFactoryClassName);
  OrgApacheLuceneStoreFSDirectory *lockDir = [new_OrgApacheLuceneStoreSimpleFSDirectory_initWithOrgLukhnosPortmobileFilePath_withOrgApacheLuceneStoreLockFactory_(lockDirPath, JreLoadStatic(OrgApacheLuceneStoreNoLockFactory, INSTANCE_)) autorelease];
  JavaNetInetSocketAddress *addr = [new_JavaNetInetSocketAddress_initWithNSString_withInt_(verifierHost, verifierPort) autorelease];
  [((JavaIoPrintStream *) nil_chk(JreLoadStatic(JavaLangSystem, out_))) printlnWithNSString:JreStrcat("$@$I$", @"Connecting to server ", addr, @" and registering as client ", myID, @"...")];
  {
    JavaLangThrowable *__mainException = nil;
    JavaNetSocket *socket = [new_JavaNetSocket_init() autorelease];
    @try {
      [socket setReuseAddressWithBoolean:YES];
      [socket connectWithJavaNetSocketAddress:addr withInt:500];
      JavaIoOutputStream *out = [socket getOutputStream];
      JavaIoInputStream *in = [socket getInputStream];
      [((JavaIoOutputStream *) nil_chk(out)) writeWithInt:myID];
      [out flush];
      OrgApacheLuceneStoreLockFactory *verifyLF = [new_OrgApacheLuceneStoreVerifyingLockFactory_initWithOrgApacheLuceneStoreLockFactory_withJavaIoInputStream_withJavaIoOutputStream_(lockFactory, in, out) autorelease];
      JavaUtilRandom *rnd = [new_JavaUtilRandom_init() autorelease];
      if ([((JavaIoInputStream *) nil_chk(in)) read] != 43) {
        @throw [new_JavaIoIOException_initWithNSString_(@"Protocol violation") autorelease];
      }
      for (jint i = 0; i < count; i++) {
        {
          JavaLangThrowable *__mainException = nil;
          OrgApacheLuceneStoreLock *l = [verifyLF obtainLockWithOrgApacheLuceneStoreDirectory:lockDir withNSString:OrgApacheLuceneStoreLockStressTest_LOCK_FILE_NAME_];
          @try {
            if ([rnd nextIntWithInt:10] == 0) {
              if ([rnd nextBoolean]) {
                verifyLF = [new_OrgApacheLuceneStoreVerifyingLockFactory_initWithOrgApacheLuceneStoreLockFactory_withJavaIoInputStream_withJavaIoOutputStream_(OrgApacheLuceneStoreLockStressTest_getNewLockFactoryWithNSString_(lockFactoryClassName), in, out) autorelease];
              }
              {
                JavaLangThrowable *__mainException = nil;
                OrgApacheLuceneStoreLock *secondLock = [verifyLF obtainLockWithOrgApacheLuceneStoreDirectory:lockDir withNSString:OrgApacheLuceneStoreLockStressTest_LOCK_FILE_NAME_];
                @try {
                  @throw [new_JavaIoIOException_initWithNSString_(@"Double obtain") autorelease];
                }
                @catch (OrgApacheLuceneStoreLockObtainFailedException *loe) {
                  __mainException = loe;
                }
                @finally {
                  @try {
                    [secondLock close];
                  }
                  @catch (JavaLangThrowable *e) {
                    if (__mainException) {
                      [__mainException addSuppressedWithJavaLangThrowable:e];
                    } else {
                      __mainException = e;
                    }
                  }
                  if (__mainException) {
                    @throw __mainException;
                  }
                }
              }
            }
            JavaLangThread_sleepWithLong_(sleepTimeMS);
          }
          @catch (OrgApacheLuceneStoreLockObtainFailedException *loe) {
            __mainException = loe;
          }
          @finally {
            @try {
              [l close];
            }
            @catch (JavaLangThrowable *e) {
              if (__mainException) {
                [__mainException addSuppressedWithJavaLangThrowable:e];
              } else {
                __mainException = e;
              }
            }
            if (__mainException) {
              @throw __mainException;
            }
          }
        }
        if (i % 500 == 0) {
          [JreLoadStatic(JavaLangSystem, out_) printlnWithNSString:JreStrcat("D$", (i * 100. / count), @"% done.")];
        }
        JavaLangThread_sleepWithLong_(sleepTimeMS);
      }
    }
    @finally {
      @try {
        [socket close];
      }
      @catch (JavaLangThrowable *e) {
        if (__mainException) {
          [__mainException addSuppressedWithJavaLangThrowable:e];
        } else {
          __mainException = e;
        }
      }
      if (__mainException) {
        @throw __mainException;
      }
    }
  }
  [JreLoadStatic(JavaLangSystem, out_) printlnWithNSString:JreStrcat("$I$", @"Finished ", count, @" tries.")];
}

OrgApacheLuceneStoreFSLockFactory *OrgApacheLuceneStoreLockStressTest_getNewLockFactoryWithNSString_(NSString *lockFactoryClassName) {
  OrgApacheLuceneStoreLockStressTest_initialize();
  @try {
    return (OrgApacheLuceneStoreFSLockFactory *) check_class_cast([((JavaLangReflectField *) nil_chk([((IOSClass *) nil_chk(IOSClass_forName_(lockFactoryClassName))) getField:@"INSTANCE"])) getWithId:nil], [OrgApacheLuceneStoreFSLockFactory class]);
  }
  @catch (JavaLangException *e) {
  }
  @try {
    return [((IOSClass *) nil_chk([((IOSClass *) nil_chk(IOSClass_forName_(lockFactoryClassName))) asSubclass:OrgApacheLuceneStoreFSLockFactory_class_()])) newInstance];
  }
  @catch (JavaLangException *e) {
  }
  @throw [new_JavaIoIOException_initWithNSString_(JreStrcat("$$", @"Cannot get lock factory singleton of ", lockFactoryClassName)) autorelease];
}

void OrgApacheLuceneStoreLockStressTest_init(OrgApacheLuceneStoreLockStressTest *self) {
  NSObject_init(self);
}

OrgApacheLuceneStoreLockStressTest *new_OrgApacheLuceneStoreLockStressTest_init() {
  OrgApacheLuceneStoreLockStressTest *self = [OrgApacheLuceneStoreLockStressTest alloc];
  OrgApacheLuceneStoreLockStressTest_init(self);
  return self;
}

J2OBJC_CLASS_TYPE_LITERAL_SOURCE(OrgApacheLuceneStoreLockStressTest)
